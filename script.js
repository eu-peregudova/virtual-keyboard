const data = JSON.parse('[[{"code": "Backquote", "russian": "ё", "english": "`", "russianUp": "Ё", "englishUp": "~"}, {"code": "Digit1", "russian": "1", "english": "1", "russianUp": "!", "englishUp": "!"}, {"code": "Digit2", "russian": "2", "english": "2", "russianUp": "\\"", "englishUp": "@"}, {"code": "Digit3", "russian": "3", "english": "3", "russianUp": "№", "englishUp": "#"}, {"code": "Digit4", "russian": "4", "english": "4", "russianUp": ";", "englishUp": "$"}, {"code": "Digit5", "russian": "5", "english": "5", "russianUp": "%", "englishUp": "%"}, {"code": "Digit6", "russian": "6", "english": "6", "russianUp": ":", "englishUp": "^"}, {"code": "Digit7", "russian": "7", "english": "7", "russianUp": "?", "englishUp": "&"}, {"code": "Digit8", "russian": "8", "english": "8", "russianUp": "*", "englishUp": "*"}, {"code": "Digit9", "russian": "9", "english": "9", "russianUp": "(", "englishUp": "("}, {"code": "Digit0", "russian": "0", "english": "0", "russianUp": ")", "englishUp": ")"}, {"code": "Minus", "russian": "-", "english": "-", "russianUp": "_", "englishUp": "_"}, {"code": "Equal", "russian": "=", "english": "=", "russianUp": "+", "englishUp": "+"}, {"code": "Backspace", "russian": "Backspace", "english": "Backspace", "russianUp": "Backspace", "englishUp": "Backspace"}], [{"code": "Tab", "russian": "Tab", "english": "Tab", "russianUp": "Tab", "englishUp": "Tab"}, {"code": "KeyQ", "russian": "й", "english": "q", "russianUp": "Й", "englishUp": "Q"}, {"code": "KeyW", "russian": "ц", "english": "w", "russianUp": "Ц", "englishUp": "W"}, {"code": "KeyE", "russian": "у", "english": "e", "russianUp": "У", "englishUp": "E"}, {"code": "KeyR", "russian": "к", "english": "r", "russianUp": "К", "englishUp": "R"}, {"code": "KeyT", "russian": "е", "english": "t", "russianUp": "Е", "englishUp": "T"}, {"code": "KeyY", "russian": "н", "english": "y", "russianUp": "Н", "englishUp": "Y"}, {"code": "KeyU", "russian": "г", "english": "u", "russianUp": "Г", "englishUp": "U"}, {"code": "KeyI", "russian": "ш", "english": "i", "russianUp": "Ш", "englishUp": "I"}, {"code": "KeyO", "russian": "щ", "english": "o", "russianUp": "Щ", "englishUp": "O"}, {"code": "KeyP", "russian": "з", "english": "p", "russianUp": "З", "englishUp": "P"}, {"code": "BracketLeft", "russian": "х", "english": "[", "russianUp": "Х", "englishUp": "{"}, {"code": "BracketRight", "russian": "ъ", "english": "]", "russianUp": "Ъ", "englishUp": "}"}, {"code": "Backslash", "russian": "\\\\", "english": "\\\\", "russianUp": "/", "englishUp": "|"}, {"code": "Delete", "russian": "Del", "english": "Del", "russianUp": "Del", "englishUp": "Del"}], [{"code": "CapsLock", "russian": "Caps", "english": "Caps", "russianUp": "Caps", "englishUp": "Caps"}, {"code": "KeyA", "russian": "ф", "english": "a", "russianUp": "Ф", "englishUp": "A"}, {"code": "KeyS", "russian": "ы", "english": "s", "russianUp": "Ы", "englishUp": "S"}, {"code": "KeyD", "russian": "в", "english": "d", "russianUp": "В", "englishUp": "D"}, {"code": "KeyF", "russian": "а", "english": "f", "russianUp": "А", "englishUp": "F"}, {"code": "KeyG", "russian": "п", "english": "g", "russianUp": "П", "englishUp": "G"}, {"code": "KeyH", "russian": "р", "english": "h", "russianUp": "Р", "englishUp": "H"}, {"code": "KeyJ", "russian": "о", "english": "j", "russianUp": "О", "englishUp": "J"}, {"code": "KeyK", "russian": "л", "english": "k", "russianUp": "Л", "englishUp": "K"}, {"code": "KeyL", "russian": "д", "english": "l", "russianUp": "Д", "englishUp": "L"}, {"code": "Semicolon", "russian": "ж", "english": ";", "russianUp": "Ж", "englishUp": ":"}, {"code": "Quote", "russian": "э", "english": "\'", "russianUp": "Э", "englishUp": "\\""}, {"code": "Enter", "russian": "Enter", "english": "Enter", "russianUp": "Enter", "englishUp": "Enter"}], [{"code": "ShiftLeft", "russian": "Shift", "english": "Shift", "russianUp": "Shift", "englishUp": "Shift"}, {"code": "KeyZ", "russian": "я", "english": "z", "russianUp": "Я", "englishUp": "Z"}, {"code": "KeyX", "russian": "ч", "english": "x", "russianUp": "Ч", "englishUp": "X"}, {"code": "KeyC", "russian": "с", "english": "c", "russianUp": "С", "englishUp": "C"}, {"code": "KeyV", "russian": "м", "english": "v", "russianUp": "М", "englishUp": "V"}, {"code": "KeyB", "russian": "и", "english": "b", "russianUp": "И", "englishUp": "B"}, {"code": "KeyN", "russian": "т", "english": "n", "russianUp": "Т", "englishUp": "N"}, {"code": "KeyM", "russian": "ь", "english": "m", "russianUp": "Ь", "englishUp": "M"}, {"code": "Comma", "russian": "б", "english": ",", "russianUp": "Б", "englishUp": "<"}, {"code": "Period", "russian": "ю", "english": ".", "russianUp": "Ю", "englishUp": ">"}, {"code": "Slash", "russian": ".", "english": "/", "russianUp": ",", "englishUp": "?"}, {"code": "ShiftRight", "russian": "Shift", "english": "Shift", "russianUp": "Shift", "englishUp": "Shift"}], [{"code": "ControlLeft", "russian": "Ctrl", "english": "Ctrl", "russianUp": "Ctrl", "englishUp": "Ctrl"}, {"code": "MetaLeft", "russian": "Win", "english": "Win", "russianUp": "Win", "englishUp": "Win"}, {"code": "AltLeft", "russian": "Alt", "english": "Alt", "russianUp": "Alt", "englishUp": "Alt"}, {"code": "Space", "russian": " ", "english": " ", "russianUp": " ", "englishUp": " "}, {"code": "AltRight", "russian": "Alt", "english": "Alt", "russianUp": "Alt", "englishUp": "Alt"}, {"code": "ControlRight", "russian": "Ctrl", "english": "Ctrl", "russianUp": "Ctrl", "englishUp": "Ctrl"}, {"code": "ArrowLeft", "russian": "◀", "english": "◀", "russianUp": "◀", "englishUp": "◀"}, {"code": "ArrowUp", "russian": "▲", "english": "▲", "russianUp": "▲", "englishUp": "▲"}, {"code": "ArrowDown", "russian": "▼", "english": "▼", "russianUp": "▼", "englishUp": "▼"}, {"code": "ArrowRight", "russian": "▶", "english": "▶", "russianUp": "▶", "englishUp": "▶"}]]')

let mainArea = document.createElement('main')
let textArea = document.createElement('textarea')
let keysPlate = document.createElement('div')
let langDescription = document.createElement('p')
keysPlate.classList.add('keys-plate')

let capsState = false;


if (!localStorage.getItem('language')) {
    localStorage.setItem('language', 'english')
}


let functionKeys = ['Tab', 'CapsLock', 'Shift', 'Alt', 'Control', 'Meta', 'Backspace', 'Enter',
    'ArrowRight', 'ArrowLeft', 'ArrowUp', 'ArrowDown', 'Delete']

const capsLock = document.querySelector('#CapsLock')

document.body.append(mainArea);
mainArea.append(langDescription);
langDescription.innerText = localStorage.getItem('language') === 'english' ?
    `to change the language ctrl + alt`
    : `для смены языка ctrl + alt`
mainArea.append(textArea, keysPlate);

let keys = [];

for (let j = 0; j < data.length; j += 1) {
    let lang = localStorage.getItem('language')
    let row = document.createElement('div')
    row.classList.add(`row`)
    row.classList.add(`row--${j + 1}`)
    keysPlate.append(row)

    for (let i = 0; i < data[j].length; i += 1) {
        let key = document.createElement('button')
        keys.push(key)
        key.innerText = data[j][i][`${lang}`]
        key.id = data[j][i]['code']
        key.classList.add('button-key')
        key.dataset.russian = data[j][i]['russian']
        key.dataset.russianUp = data[j][i]['russianUp']
        key.dataset.english = data[j][i]['english']
        key.dataset.englishUp = data[j][i]['englishUp']
        row.append(key)
    }
}

function langChange(caps, shift) {
    let up = caps ^ shift ? 'Up' : ''
    if (localStorage.getItem('language') === 'russian') {
        for (let i of keys) {
            i.innerText = i.dataset[`russian${up}`]
        }
    } else {
        for (let i of keys) {
            i.innerText = i.dataset[`english${up}`]
        }
    }
    langDescription.innerText = localStorage.getItem('language') === 'english'
        ? `to change the language ctrl + alt`
        : `для смены языка ctrl + alt`
    if (caps) {
        capsLock.classList.add('caps--active')
    } else {
        capsLock.classList.remove('caps--active')
    }
}

function charWrite(char) {
    let caretStart = textArea.selectionStart
    textArea.value = textArea.value.slice(0, textArea.selectionStart) + char + textArea.value.slice(textArea.selectionStart, textArea.value.length)
    textArea.selectionStart = caretStart + char.length
    textArea.selectionEnd = caretStart + char.length
}

function findChar(code, shift) {
    let language = localStorage.getItem('language')
    let up = capsState ^ shift ? 'Up' : ''
    for (let object of data.flat()) {
        if (object.code === code) {
            return object[`${language}${up}`]
        }
    }
}

document.addEventListener('keydown', (event) => {
    if (event.repeat) {
        return
    }

    textArea.focus()
    langChange(event.getModifierState('CapsLock'), event.shiftKey)

    if (event.key === 'Tab') {
        event.preventDefault()
        charWrite('    ')
    }
    if (event.key === 'CapsLock') {
        event.preventDefault()
        capsState = !capsState
    }
    if (event.altKey && event.ctrlKey) {
        localStorage.getItem('language') === 'english'
            ? localStorage.setItem('language', 'russian')
            : localStorage.setItem('language', 'english')
        langChange()
    }

    if (!functionKeys.includes(event.key)) {
        event.preventDefault()
        charWrite(findChar(event.code, event.shiftKey))
    }

    document.querySelector(`#${event.code}`).classList.add('key-button--active')
})

document.addEventListener('keyup', (event) => {
    langChange(event.getModifierState('CapsLock'), event.shiftKey)

    if (event.repeat) {
        return
    }

    document.querySelector(`#${event.code}`).classList.remove('key-button--active')
})

document.addEventListener('click', (e) => {
    let caps = e.getModifierState('CapsLock') ^ e.shiftKey ? 'Up' : ''
    langChange(e.getModifierState('CapsLock'), e.shiftKey)


    if (!e.target.classList.contains('button-key')) {
        return
    }
    const lang = localStorage.getItem('language')
    textArea.focus()

    if (e.target.id === 'Backspace' || e.target.id === 'Delete') {
        let caretStart = textArea.selectionStart
        let caretEnd = textArea.selectionEnd
        let back = Number(e.target.id === 'Backspace')
        if (caretEnd !== caretStart) {
            textArea.value = textArea.value.slice(0, caretStart) + textArea.value.slice(caretEnd, textArea.value.length)
            textArea.selectionStart = caretStart
            textArea.selectionEnd = caretStart
        } else {
            textArea.value = textArea.value.slice(0, caretStart - back) + textArea.value.slice(caretStart + 1 - back, textArea.value.length)
            textArea.selectionStart = caretStart - back
            textArea.selectionEnd = caretStart - back
        }
    } else if (e.target.id === 'Tab') {
        textArea.value = textArea.value.slice(0, textArea.selectionStart) + '    ' + textArea.value.slice(textArea.selectionStart, textArea.value.length)
    } else if (e.target.id === 'Enter') {
        textArea.value = textArea.value.slice(0, textArea.selectionStart) + '\n' + textArea.value.slice(textArea.selectionStart, textArea.value.length)
    } else if (e.target.id === 'ControlLeft'
        || e.target.id === 'ControlRight'
        || e.target.id === 'AltLeft'
        || e.target.id === 'AltRight'
        || e.target.id === 'MetaLeft'
        || e.target.id === 'ShiftRight'
        || e.target.id === 'ShiftLeft') {

    } else if (e.target.id === 'CapsLock') {
        langChange(true)
    } else {
        charWrite(e.target.dataset[`${lang}${caps}`])
    }

})

document.addEventListener('mousedown', (e) => {
    if (e.target.id === 'ShiftRight' || e.target.id === 'ShiftLeft') {
        langChange(e.getModifierState('CapsLock'), true)
    }
})

document.addEventListener('mouseup', (e) => {
    if (e.target.id === 'ShiftRight' || e.target.id === 'ShiftLeft') {
        langChange(e.getModifierState('CapsLock'), false)
    }
})
